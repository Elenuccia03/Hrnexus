@model DipendenteViewModel
<link rel="stylesheet" href="~/css/calendariolavoratori.css">
<div class="search-container">
    <form asp-action="CalendarioLavoratori" method="get">
        <input class="search" type="text" id="nome" name="nome" placeholder="Cerca dipendente" />
        <input type="hidden" id="annoCorrente" name="annoCorrente" />
        <input type="hidden" id="meseCorrente" name="meseCorrente" />
        <button type="submit" class="search-btn">Cerca</button>
    </form>
</div>

@if (Model != null)
{
    @if (Model.DipendenteTrovato)
    {
        int meseCorrente = Model.MeseProgrammazione;
        int annoCorrente = Model.AnnoProgrammazione;
        string meseTestuale = new DateTime(Model.AnnoProgrammazione, Model.MeseProgrammazione, 1).ToString("MMMM");
        <div>
            <form asp-action="CalendarioLavoratori" method="get">
                <input type="hidden" name="nome" value="@Model.Nome" />
                <input type="hidden" name="annoCorrente" value="@Model.AnnoProgrammazione" />
                <input type="hidden" name="meseCorrente" value="@Model.MeseProgrammazione" />
                <div class="month-selector">
                    <button type="submit" name="direzione" value="precedente">precedente</button>
                    <span>@meseTestuale</span>
                    <span>@annoCorrente</span>
                    <button type="submit" name="direzione" value="successivo">successivo</button>
                </div>
            </form>
        </div>
        <div class="calendar">
            @for (int i = 1; i <= DateTime.DaysInMonth(Model.AnnoProgrammazione, Model.MeseProgrammazione); i++)
            {
                <div class="day">
                    @i
                    @{
                        ProgrammazioneViewModel programmazione = Model.Programmazioni.FirstOrDefault(pm => pm.DataGiorno.Day == i);

                        if (programmazione != null)
                        {
                            string cssClass = "";
                            bool isTimbraturaIrregolare = false; // Da rivedere la logica per questa variabile
                            bool isTimbraturaRegolare = true; // Da rivedere la logica per questa variabile
                            TimeSpan durataProgrammata = programmazione.InizioTurno - programmazione.FineTurno;

                            if (programmazione.TimbraturaInizio != null && programmazione.TimbraturaUscita != null)
                            {
                                TimeSpan? durataEffettiva = programmazione.TimbraturaInizio - programmazione.TimbraturaUscita;
                                TimeSpan? differenza = durataProgrammata - durataEffettiva;
                                if (differenza.HasValue && differenza.Value.TotalMinutes > 15)
                                {
                                    isTimbraturaIrregolare = true;
                                }
                                else
                                {
                                    isTimbraturaRegolare = true;
                                }
                            }
                            bool isFerie = programmazione.GiornoFerie;
                            bool isPermesso = programmazione.GiornoPermesso;
                            bool isMalattia = programmazione.GiornoMalattia;

                            if (isTimbraturaRegolare)
                            {
                                cssClass = "regolare";
                            }
                            if (isTimbraturaIrregolare)
                            {
                                cssClass = "irregolare";
                            }
                            if (isFerie)
                            {
                                cssClass = "ferie";
                            }
                            if (isMalattia)
                            {
                                cssClass = "malattia";
                            }
                            if (isPermesso)
                            {
                                cssClass = "permesso";
                            }

                            <div class="@cssClass">
                                <i class="fa-solid fa-square-check"></i>
                                <span>@programmazione.GiornoMalattia</span>
                            </div>
                        }
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div>
            dipendente non trovato
        </div>
    }
}
else
{
    <div>
        benvenuto nella sezione calendario
    </div>
}

<script>
    const dataCorrente = new Date();
    const annoCorrente = dataCorrente.getFullYear();
    const meseCorrente = dataCorrente.getMonth() + 1; // I mesi vanno da 0 (gennaio) a 11 (dicembre)

    // Impostare i valori degli input nascosti
    document.getElementById('annoCorrente').value = annoCorrente;
    document.getElementById('meseCorrente').value = meseCorrente;
</script>
